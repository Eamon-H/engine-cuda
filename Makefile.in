#
# @version 0.1.1 (2010)
# @author Paolo Margara <paolo.margara@gmail.com>
# 
# Copyright 2010 Paolo Margara
#
# This file is part of Engine_cudamrg.
#
# Engine_cudamrg is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License or
# any later version.
# 
# Engine_cudamrg is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Engine_cudamrg.  If not, see <http://www.gnu.org/licenses/>.
#

CC = @CC@
NVCC = @NVCC@

VERSION = @VERSION@

LDFLAGS= @LDFLAGS@
NVLDFLAGS= @NVLDFLAGS@

CPPFLAGS= @CPPFLAGS@
NVCPPFLAGS= @NVCPPFLAGS@

CFLAGS= @CFLAGS@

NVCFLAGS_LIBS = @NVCFLAGS@ --compiler-options '@CFLAGS@'
NVCFLAGS_TEST = @NVCFLAGS@ --compiler-options '@CFLAGS_TEST@'

LIBS_TEST = @LIBS_TEST@
LIBS_LIBS = @LIBS@
LIBS_OPENCL = -lcrypto -lOpenCL

LIBNAME = libcudamrg.so
LIBNAME_OPENCL = libopencl.so
TESTNAME= teststate

COMMONSRC_CUDA = common.h cuda_common.h cuda_common.cu Makefile
COMMONSRC_OPENCL = common.h opencl_common.c opencl_common.h Makefile
TESTSRC= teststate.c aes_cuda.cu

LIBOBJ = e_cuda.o 
LIBOBJ_CUDA = aes_cuda.o des_cuda.o idea_cuda.o bf_cuda.o cast_cuda.o cmll_cuda.o cuda_common.o 

LIBOBJ_OPENCL = e_opencl.o bf_opencl.o des_opencl.o cast_opencl.o opencl_common.o

TESTOBJ= aes_cuda.o teststate.o

all: $(LIBNAME) $(LIBNAME_OPENCL)

test: $(TESTNAME)

$(TESTNAME): $(TESTSRC)
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_TEST) $(NVLDFLAGS) $(LIBS_TEST) -o $(TESTNAME) $(TESTSRC)

$(LIBNAME): $(LIBOBJ) $(LIBOBJ_CUDA)
	$(CC) -fPIC -shared -Wl,-soname,$(LIBNAME) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $(LIBS_LIBS) -o $(LIBNAME) $(LIBOBJ) $(LIBOBJ_CUDA)

$(LIBNAME_OPENCL): $(LIBOBJ_OPENCL)
	$(CC) -fPIC -shared -Wl,-soname,$(LIBNAME_OPENCL) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $(LIBS_OPENCL) -o $(LIBNAME_OPENCL) $(LIBOBJ_OPENCL)

$(LIBOBJ_OPENCL): %.o: %.c $(COMMONSRC_OPENCL)
	$(CC) $(CFLAGS) -Wno-comments $(CPPFLAGS) $(LDFLAGS) -c -o $@ $<

$(LIBOBJ_CUDA): %.o: %.cu $(COMMONSRC_CUDA)
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_LIBS) -c -o $@ $<

$(LIBOBJ): %.o: %.c $(COMMONSRC_CUDA)
	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) -c -o $@ $<

ptx:
kernels.ptx: opencl_kernels.cl
	clcc "-cl-nv-arch sm_11" opencl_kernels.cl $@
	
install: $(LIBNAME)
	mkdir -p @prefix@/@ENGINEDIR@
	cp $(LIBNAME) @prefix@/@ENGINEDIR@

clean:
	rm -f *.o *.obj tags core .pure *.out .nfs* *.old *.bak fluff *.linkinfo *.so *.a teststate config.log config.status
	rm -f *.cpp1.ii *.cpp2.i *.cpp3.i *.cpp4.ii *.cu.cpp *.cudafe1.c *.cudafe1.cpp *.cudafe1.gpu 
	rm -f *.cudafe1.stub.c *.cudafe2.c *.cudafe2.gpu *.cudafe2.stub.c *.fatbin.c *.hash *.ptx *.sm_*.cubin

distclean: clean
	rm -f config.* Makefile

tags:
	/usr/bin/env ctags *.c *.h *.cu

.PHONY: all clean distclean install tags
