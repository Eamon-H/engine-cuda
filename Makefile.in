#
# @version 0.1.0 (2010)
# @author Paolo Margara <paolo.margara@gmail.com>
# 
# Copyright 2010 Paolo Margara
#
# This file is part of Engine_cudamrg.
#
# Engine_cudamrg is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License or
# any later version.
# 
# Engine_cudamrg is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Engine_cudamrg.  If not, see <http://www.gnu.org/licenses/>.
#

CC = @CC@
NVCC = @NVCC@

VERSION = @VERSION@

LDFLAGS= @LDFLAGS@
NVLDFLAGS= @NVLDFLAGS@

CPPFLAGS= @CPPFLAGS@
NVCPPFLAGS= @NVCPPFLAGS@

CFLAGS= @CFLAGS@

NVCFLAGS_LIBS = @NVCFLAGS@ --compiler-options '@CFLAGS@'
NVCFLAGS_TEST = @NVCFLAGS@ --compiler-options '@CFLAGS_TEST@'

LIBS_TEST = @LIBS_TEST@
LIBS_LIBS = @LIBS@

LIBNAME = libcudamrg.so
TESTNAME= teststate

LIBSRC = e_cuda.c aes_cuda.cu des_cuda.cu idea_cuda.cu cuda_common.cu common.c
TESTSRC= teststate.c aes_cuda.cu

LIBOBJ = e_cuda.o aes_cuda.o des_cuda.o idea_cuda.o cuda_common.o common.o
TESTOBJ= aes_cuda.o teststate.o

all: $(LIBNAME)

test: $(TESTNAME)

$(TESTNAME): $(TESTSRC)
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_TEST) $(NVLDFLAGS) $(LIBS_TEST) -o $(TESTNAME) $(TESTSRC)

$(LIBNAME): $(LIBOBJ)
	$(CC) -fPIC -shared -Wl,-soname,$(LIBNAME) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) $(LIBS_LIBS) -o $(LIBNAME) $(LIBOBJ)

aes_cuda.o: aes_cuda.cu cuda_common.cu
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_LIBS) -c -o aes_cuda.o aes_cuda.cu 

des_cuda.o: des_cuda.cu cuda_common.cu
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_LIBS) -c -o des_cuda.o des_cuda.cu

idea_cuda.o: idea_cuda.cu cuda_common.cu
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_LIBS) -c -o idea_cuda.o idea_cuda.cu

common.o: common.c
	$(CC) $(CFLAGS) $(CPPFLAGS) $(LDFLAGS) -c -o common.o common.c

cuda_common.o: cuda_common.cu cuda_common.h
	$(NVCC) $(NVCPPFLAGS) $(NVCFLAGS_LIBS) -c -o cuda_common.o cuda_common.cu

install: $(LIBNAME)
	mkdir -p @prefix@/@ENGINEDIR@
	cp $(LIBNAME) @prefix@/@ENGINEDIR@

clean:
	rm -f *.o *.obj lib tags core .pure *.out .nfs* *.old *.bak fluff *.linkinfo *.so *.a teststate
	rm -f *.cpp1.ii *.cpp2.i *.cpp3.i *.cpp4.ii *.cu.cpp *.cudafe1.c *.cudafe1.cpp *.cudafe1.gpu 
	rm -f *.cudafe1.stub.c *.cudafe2.c *.cudafe2.gpu *.cudafe2.stub.c *.fatbin.c *.hash *.ptx *.sm_11.cubin

distclean: clean
	rm -f config.* Makefile

tags:
	/usr/bin/env ctags *.c *.h *.cu

.PHONY: all clean distclean install tags
